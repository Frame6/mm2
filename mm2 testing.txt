-- ==========================
-- SERVICES
-- ==========================
local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

-- ==========================
-- CONFIG
-- ==========================
local CHECK_MAP_DELAY = 3
local MOVE_SPEED = 22
local REACH_DIST = 2
local MAX_LINES = 300

-- ==========================
-- CHARACTER STATE
-- ==========================
local character
local humanoid
local hrp
local alive = false

-- ==========================
-- CONSOLE
-- ==========================
local function createConsole()
	local gui = Instance.new("ScreenGui")
	gui.Name = "ConsoleGui"
	gui.ResetOnSpawn = false
	gui.Parent = player:WaitForChild("PlayerGui")

	local main = Instance.new("Frame")
	main.Size = UDim2.fromScale(0.6, 0.45)
	main.Position = UDim2.fromScale(0.2, 0.5)
	main.BackgroundColor3 = Color3.fromRGB(15,15,15)
	main.BorderSizePixel = 0
	main.Parent = gui

	Instance.new("UICorner", main).CornerRadius = UDim.new(0,12)

	local title = Instance.new("TextLabel", main)
	title.Size = UDim2.new(1, -16, 0, 28)
	title.Position = UDim2.new(0, 8, 0, 8)
	title.BackgroundTransparency = 1
	title.Text = "Console"
	title.Font = Enum.Font.Code
	title.TextSize = 16
	title.TextColor3 = Color3.new(1,1,1)

	local list = Instance.new("ScrollingFrame", main)
	list.Size = UDim2.new(1, -16, 1, -48)
	list.Position = UDim2.new(0, 8, 0, 40)
	list.BackgroundColor3 = Color3.fromRGB(10,10,10)
	list.BorderSizePixel = 0
	list.ScrollBarImageTransparency = 0.2
	Instance.new("UICorner", list).CornerRadius = UDim.new(0,8)

	local layout = Instance.new("UIListLayout", list)
	layout.Padding = UDim.new(0,4)

	local lines = {}

	local function update()
		task.wait()
		list.CanvasSize = UDim2.fromOffset(0, layout.AbsoluteContentSize.Y + 8)
		list.CanvasPosition = Vector2.new(0, math.max(0, list.CanvasSize.Y.Offset - list.AbsoluteWindowSize.Y))
	end

	return function(text)
		local label = Instance.new("TextLabel")
		label.Size = UDim2.new(1, -8, 0, 18)
		label.AutomaticSize = Enum.AutomaticSize.Y
		label.BackgroundTransparency = 1
		label.TextWrapped = true
		label.Font = Enum.Font.Code
		label.TextSize = 14
		label.TextColor3 = Color3.fromRGB(220,220,220)
		label.Text = os.date("[%H:%M:%S] ") .. text
		label.Parent = list

		table.insert(lines, label)
		if #lines > MAX_LINES then
			table.remove(lines,1):Destroy()
		end
		update()
	end
end

local log = createConsole()
log("Console iniciado")

-- ==========================
-- CHARACTER HANDLING
-- ==========================
local function onCharacter(char)
	character = char
	humanoid = char:WaitForChild("Humanoid")
	hrp = char:WaitForChild("HumanoidRootPart")
	alive = true

	humanoid.Died:Once(function()
		alive = false
	end)
end

player.CharacterAdded:Connect(onCharacter)
if player.Character then
	onCharacter(player.Character)
end

-- ==========================
-- MAP / COINS
-- ==========================
local function encontrarMapa()
	for _, v in ipairs(Workspace:GetChildren()) do
		if v:FindFirstChild("Spawns") then
			return v
		end
	end
	return nil
end

local function getNearestCoin(map)
	if not map:FindFirstChild("CoinContainer") then return nil end
	if not hrp then return nil end

	local nearest
	local shortest = math.huge

	for _, coin in ipairs(map.CoinContainer:GetChildren()) do
		if coin:IsA("BasePart") then
			local d = (coin.Position - hrp.Position).Magnitude
			if d < shortest then
				shortest = d
				nearest = coin
			end
		end
	end

	return nearest
end

-- ==========================
-- PERFECT LINEAR FLIGHT
-- ==========================
local function flyConstantTo(targetPos)
	if not alive or not humanoid or not hrp then return end
	if humanoid.Health <= 0 then return end

	humanoid:ChangeState(Enum.HumanoidStateType.Physics)

	local startPos = hrp.Position
	local distance = (targetPos - startPos).Magnitude
	if distance < REACH_DIST then
		hrp.CFrame = CFrame.new(targetPos)
		return
	end

	local duration = distance / MOVE_SPEED
	local startTime = os.clock()

	local conn
	conn = RunService.Heartbeat:Connect(function()
		if not alive or humanoid.Health <= 0 or not hrp or not hrp.Parent then
			conn:Disconnect()
			return
		end

		local alpha = (os.clock() - startTime) / duration
		if alpha >= 1 then
			hrp.CFrame = CFrame.new(targetPos)
			conn:Disconnect()
			return
		end

		-- trava física (impede giro / queda)
		hrp.AssemblyLinearVelocity = Vector3.zero
		hrp.AssemblyAngularVelocity = Vector3.zero

		local pos = startPos:Lerp(targetPos, alpha)
		hrp.CFrame = CFrame.new(pos)
	end)
end

-- ==========================
-- MAIN LOOP
-- ==========================
local map

while true do
	-- esperar mapa
	while not map do
		log("Aguardando mapa...")
		task.wait(CHECK_MAP_DELAY)
		map = encontrarMapa()
	end

	log("Mapa encontrado: "..map.Name)

	-- farm
	while map and map.Parent and alive do
		local coin = getNearestCoin(map)
		if not coin then
			log("Sem moedas...")
			task.wait(1)
		else
			log("Indo até moeda")
			flyConstantTo(coin.Position)
			task.wait(0.15)
		end
	end

	log("Mapa sumiu ou player morreu")
	map = nil
end
